<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        label { margin-right: 10px; }
        select, input { margin-right: 20px; }
        canvas { margin-top: 20px; max-width: 100%; height: 400px; }
        #alerts { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>IoT Dashboard</h1>

    <label>Устройство:</label>
    <select id="deviceSelect">
        <option value="myRasp">Raspberry Pi 1</option>
    </select>

    <label>С:</label>
    <input type="datetime-local" id="dateFrom">

    <label>По:</label>
    <input type="datetime-local" id="dateTo">

    <label>Тип сенсора:</label>
    <select id="sensorType">
        <option value="temperature">Temperature</option>
        <option value="motion">Motion</option>
        <option value="eyes">Eyes</option>
    </select>

    <button id="loadData">Загрузить</button>
    <button id="downloadCsv">Скачать CSV</button>

    <h2>График сенсоров</h2>
    <canvas id="chart"></canvas>

    <h2>Alerts</h2>
    <ul id="alerts"></ul>

<script>
const API_URL = "https://trigger-bhd7ceefhaa7d6gx.northeurope-01.azurewebsites.net/api/measurements";
const API_KEY = "test12345"; // если нужен x-api-key

const deviceSelect = document.getElementById('deviceSelect');
const chartCanvas = document.getElementById('chart').getContext('2d');
const alertsList = document.getElementById('alerts');
const downloadBtn = document.getElementById('downloadCsv');
const loadBtn = document.getElementById('loadData');
const dateFrom = document.getElementById('dateFrom');
const dateTo = document.getElementById('dateTo');
const sensorType = document.getElementById('sensorType');

let chart;

function formatDateToISOLocal(dt) {
    return dt.toISOString().slice(0,16);
}

// Подставляем дефолтные даты (последние 24 часа)
const now = new Date();
const yesterday = new Date(now.getTime() - 24*60*60*1000);
dateFrom.value = formatDateToISOLocal(yesterday);
dateTo.value = formatDateToISOLocal(now);

async function loadDeviceData() {
    const deviceId = deviceSelect.value;
    const type = sensorType.value;

    const t_from = new Date(dateFrom.value).toISOString().split('.')[0] + 'Z';
    const t_to = new Date(dateTo.value).toISOString().split('.')[0] + 'Z';

    try {
        const res = await fetch(`${API_URL}?deviceId=${deviceId}&from=${t_from}&to=${t_to}&type=${type}`, {
            headers: { "x-api-key": API_KEY }
        });
        const data = await res.json();

        if (!data.items) return;

        // Сортировка по timestamp
        const items = data.items.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

        const labels = items.map(d => d.timestamp);
        const values = items.map(d => d.val ?? d.value ?? d.motion ?? 0);

        if (chart) chart.destroy();

        chart = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: type,
                    data: values,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.2,
                }]
            },
            options: {
                responsive: true,
                scales: { x: { display: true }, y: { beginAtZero: true } }
            }
        });

        // Alerts: покажем температуры > 28 или < 19
        alertsList.innerHTML = '';
        items.forEach(item => {
            if (type === "temperature" && (item.val > 28 || item.val < 19)) {
                const li = document.createElement('li');
                li.textContent = `${item.timestamp}: Temperature alert ${item.val}°C`;
                alertsList.appendChild(li);
            }
        });

        // CSV
        downloadBtn.onclick = () => {
            const csv = ["timestamp,value"].concat(items.map(d => `${d.timestamp},${d.val ?? d.value ?? d.motion ?? 0}`)).join("\n");
            const blob = new Blob([csv], {type: "text/csv"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `device_${deviceId}_${type}.csv`;
            a.click();
        }

    } catch(err) {
        console.error(err);
        alert("Ошибка загрузки данных");
    }
}

// Загрузка по кнопке
loadBtn.addEventListener('click', loadDeviceData);

// Загружаем сразу при старте
loadDeviceData();
</script>
</body>
</html>
